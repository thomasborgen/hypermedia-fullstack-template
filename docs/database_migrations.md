
## Adding required fields.

When adding required fields we usually have to update old records so that they have some value in these fields.

Create your model like normal with the required field and create a new alembic revision

```sh
uv run alembic revision --autogenerate -m "color new_field"
```

It will look something like the following. Notice the `nullable=False`

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('color', sa.Column('test', sqlmodel.sql.sqltypes.AutoString(), nullable=False))
    
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('color', 'test')
    # ### end Alembic commands ###

```

We need to split this one line into 3 operations.

1. Remove the `nullable=False`, this will create an optional field
2. Add some data to the field
3. Alter the field, adding `nullable=False`

```python

def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column(
        "color", sa.Column("test", sqlmodel.sql.sqltypes.AutoString())
    )

    op.execute('UPDATE "color" SET test = name')

    op.alter_column(
        "color",
        "test",
        nullable=False,
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("color", "test")
    # ### end Alembic commands ###
```


## Data migration

When creating a data migration it is important to do it with the table configuration the database had at the time of the migration.

There are two options to do this.

### Adding data at table creation time.

This works only when the table is being created the first time, but this is also the easiest way to do it.

```python

def upgrade() -> None:

    # Get the table returned from create_table, This is not our SQLModel instance, but a specific representation of the table in this migration.
    color_table = op.create_table(
        "color",
        sa.Column("created_at", sa.DateTime(), nullable=False),
        sa.Column("updated_at", sa.DateTime(), nullable=False),
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column("name", sqlmodel.sql.sqltypes.AutoString(), nullable=False),
        sa.Column("slug", sqlmodel.sql.sqltypes.AutoString(), nullable=False),
        sa.Column("hex", sqlmodel.sql.sqltypes.AutoString(), nullable=False),
        sa.Column(
            "description", sqlmodel.sql.sqltypes.AutoString(), nullable=True
        ),
        sa.PrimaryKeyConstraint("id"),
    )

    # Add the data

    colors = [
        ["Hvit", "hvit", "#ffffff"],
        ["Svart", "svart", "#000000"],
        ["Grå", "graa", "#808080"],
        ["Beige", "beige", "#F5F5DC"],
        ["Brun", "brun", "#8B4513"],
        ["Rød", "rød", "#ff0000"],
        ["Blå", "bla", "#0000ff"],
        ["Grønn", "gronn", "#00ff00"],
        ["Gul", "gul", "#ffff00"],
        ["Orange", "orange", "#FFA500"],
        ["Rosa", "rosa", "#FFC0CB"],
        ["Lilla", "lilla", "#800080"],
        ["Sølv", "sølv", "#C0C0C0"],
        ["Gull", "gull", "#FFD700"],
    ]
    now = datetime.now(timezone.utc)
    op.bulk_insert(
        color_table,
        [
            {
                "id": uuid4(),
                "name": col[0],
                "slug": col[1],
                "hex": col[2],
                "created_at": now,
                "updated_at": now,
            }
            for col in colors
        ],
    )

```

### Adding data in a separate migration


The other solution is to add data by getting the reflected table in a migration.

start by adding a new empty revision.

```sh
uv run alembic revision -m "add colors"
```

```python
def upgrade():

    # get metadata from current connection
    meta = MetaData(bind=op.get_bind())

    # pass in tuple with tables we want to reflect, otherwise whole database will get reflected
    meta.reflect(only=('color',))

    # define table representation
    color_table = Table('color', meta)

    # insert records
    op.bulk_insert(
        color_table,
        [
            {
                # data here...
            },  # (...)
        ]

```


## Downgrading


```sh
uv run alembic downgrade -1
```
