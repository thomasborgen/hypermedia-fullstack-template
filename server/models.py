from datetime import datetime, timezone

from pydantic import ConfigDict
from sqlmodel import Field, SQLModel

# Conventions are here for naming indexes, constraints etc so they
# can be referenced in alembic migrations and changed.
convention = {
    "ix": "ix_%(column_0_label)s",
    "uq": "uq_%(table_name)s_%(column_0_name)s",
    "ck": "ck_%(table_name)s_%(constraint_name)s",
    "fk": "fk_%(table_name)s_%(column_0_name)s_%(referred_table_name)s",
    "pk": "pk_%(table_name)s",
}


class SimpleModel(SQLModel):
    """Base model for everything."""

    model_config = ConfigDict(
        protected_namespaces=(),
    )  # type: ignore


SimpleModel.metadata.naming_convention = convention


class BaseModel(SimpleModel):
    """Base model for all that can be created and updated."""

    created_at: datetime | None = Field(
        default_factory=lambda: datetime.now(timezone.utc),
        nullable=False,
    )
    updated_at: datetime | None = Field(
        default_factory=lambda: datetime.now(timezone.utc),
        nullable=False,
        sa_column_kwargs={
            "onupdate": lambda: datetime.now(timezone.utc),
        },
    )
